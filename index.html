<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Social Score Calculator by :SM</title>
<meta name="description" content="Publicity + Reputation → Social Score. UA/EN, PDF/PNG/ZIP export, autosave, radar charts."/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<!-- ZIP helper (client-side) -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  :root{
    --accent:#C7FF22; --ink:#151515; --muted:#667085; --bg:#FAFAFA; --card:#fff; --stroke:#E6E7EB;
    --ok:#22c55e; --mid:#f59e0b; --low:#ef4444;
    --radius:18px; --shadow:0 14px 40px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:500 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
  a{color:inherit}
  .wrap{max-width:1120px;margin:0 auto;padding:28px 20px 56px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
  .brand{font-weight:900;letter-spacing:.2px}
  .brand::before{content:":self—maestro"}
  .lang{display:flex;gap:8px;align-items:center}
  .chip{border:1px solid var(--stroke);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
  .chip.active{background:var(--accent);border-color:#b5ef12}
  .hero{background:#fff;border:1px solid var(--stroke);border-radius:28px;box-shadow:var(--shadow);padding:40px 28px;text-align:center;margin-bottom:22px}
  .h1{font-size:44px;line-height:1.08;margin:0 0 10px;font-weight:900}
  .sub{max-width:780px;margin:0 auto 18px;color:var(--muted)}
  .cta{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--ink);background:var(--ink);color:#fff;padding:12px 16px;border-radius:14px;font-weight:800;cursor:pointer}
  .btn.alt{background:#fff;color:var(--ink);border-color:var(--stroke)}
  .ribbon{border-radius:20px;padding:14px 16px;margin:22px 0;background:var(--accent);font-weight:900;text-align:center}
  .grid{display:grid;gap:16px}
  @media(min-width:980px){.grid-2{grid-template-columns:1.18fr .82fr}}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px 16px}
  .card h3{margin:0 0 10px;font-size:16px;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr 130px 130px 100px;gap:10px;align-items:center;margin:10px 0}
  input[type="number"],input[type="text"],select{width:100%;background:#fff;border:1px solid var(--stroke);color:var(--ink);padding:10px 12px;border-radius:12px;outline:none}
  input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  .mini{display:flex;gap:8px;flex-wrap:wrap}
  .mini input{width:100%}
  .hr{border-top:1px dashed var(--stroke);margin:12px 0}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
  .switch{display:flex;align-items:center;gap:8px}

  /* results */
  .score{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:6px}
  .pill{border:1px solid var(--stroke);border-radius:16px;padding:14px;background:#fff}
  .pill b{font-size:24px}
  progress{width:100%;height:12px;border-radius:999px;overflow:hidden;background:#EEF1F5;border:0}
  .ok::-webkit-progress-value{background:var(--ok)}
  .mid::-webkit-progress-value{background:var(--mid)}
  .low::-webkit-progress-value{background:var(--low)}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .badge{border-radius:10px;padding:6px 10px;font-size:13px;border:1px solid var(--stroke)}
  .b-ok{background:#E9FFE9}.b-mid{background:#FFF7DA}.b-low{background:#FFE6E6}
  .right{display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}

  footer{margin-top:28px;text-align:center;color:var(--muted)}
  footer a{font-weight:800;text-decoration:none;border-bottom:1px dashed #cbd5e1}

  /* carousel preview wall */
  .slides{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
  .slides canvas{width:100%;height:auto;border:1px solid var(--stroke);border-radius:12px;background:#000}

  @media print{.btn,.chip,header,.ribbon{display:none!important}.wrap{padding:0}.card{break-inside:avoid}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand" aria-label="self—maestro"></div>
    <div class="lang">
      <label style="font-size:14px;color:var(--muted)" data-i="modeLbl">Carousel</label>
      <select id="carouselMode">
        <option value="classic">Classic</option>
        <option value="charts">Charts/Radar</option>
      </select>
      <button class="chip active" data-lang="en">EN</button>
      <button class="chip" data-lang="ua">UA</button>
    </div>
  </header>

  <section class="hero">
    <h1 class="h1" data-i="title">Social Score Calculator by :SM</h1>
    <p class="sub" data-i="subtitle">Measure a personal brand using two dimensions: <b>Publicity</b> (visibility) and <b>Reputation</b> (perception). Default weighting: 50/50. Adjust below.</p>
    <div class="cta">
      <a class="btn" href="#calc" data-i="start">Start Now</a>
      <a class="btn alt" href="#how" data-i="how">How it works</a>
    </div>
  </section>

  <div class="ribbon">Publicity + Reputation → Social Score</div>

  <div class="grid grid-2" id="calc">
    <!-- INPUTS -->
    <section class="card">
      <h3 data-i="inputsTitle">Inputs · enter Raw + Peer Max → we normalize (0–100)</h3>

      <div class="mini" style="align-items:center;justify-content:space-between">
        <div class="switch">
          <input type="checkbox" id="logToggle">
          <label for="logToggle" class="muted" data-i="logNorm">Use log normalization for MMI & SRI (big-scale niches)</label>
        </div>
        <div class="mini">
          <button id="calcBtn" class="btn" data-i="calc">Calculate</button>
          <button id="reset" class="btn alt" data-i="reset">Reset</button>
          <button id="clearSaved" class="btn alt" data-i="clear">Clear Saved</button>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3 data-i="pub">Publicity (Visibility)</h3>
          <div class="row">
            <label>MMI</label>
            <input type="number" id="mmi_raw" placeholder="Raw"/>
            <input type="number" id="mmi_peer" placeholder="Peer Max"/>
            <input type="number" id="mmi" placeholder="0–100" title="Normalized" />
          </div>
          <div class="row">
            <label>SRI</label>
            <input type="number" id="sri_raw" placeholder="Raw"/>
            <input type="number" id="sri_peer" placeholder="Peer Max"/>
            <input type="number" id="sri" placeholder="0–100" />
          </div>
          <div class="row">
            <label>SVI</label>
            <input type="number" disabled placeholder="—"/>
            <input type="number" disabled placeholder="—"/>
            <input type="number" id="svi" placeholder="0–100 (Google Trends)"/>
          </div>
          <div class="row">
            <label>CFI</label>
            <input type="number" id="cfi_raw" placeholder="Raw"/>
            <input type="number" id="cfi_peer" placeholder="Peer Max"/>
            <input type="number" id="cfi" placeholder="0–100" />
          </div>
          <div class="hr"></div>
          <div class="mini">
            <label style="width:100%" data-i="pubW">Weights in Publicity (sum=100)</label>
            <input type="number" id="w_mmi" value="35"/>
            <input type="number" id="w_sri" value="35"/>
            <input type="number" id="w_svi" value="15"/>
            <input type="number" id="w_cfi" value="15"/>
          </div>
        </div>

        <div class="card">
          <h3 data-i="rep">Reputation (Perception)</h3>
          <div class="row">
            <label>SI</label>
            <input type="number" disabled placeholder="—"/>
            <input type="number" disabled placeholder="—"/>
            <input type="number" id="si" placeholder="% positive"/>
          </div>
          <div class="row">
            <label>CI</label>
            <input type="number" disabled placeholder="—"/>
            <input type="number" disabled placeholder="—"/>
            <input type="number" id="ci" placeholder="0–100"/>
          </div>
          <div class="row">
            <label>EI</label>
            <input type="number" id="ei_raw" placeholder="Raw"/>
            <input type="number" id="ei_peer" placeholder="Peer Max"/>
            <input type="number" id="ei" placeholder="0–100"/>
          </div>
          <div class="row">
            <label>AI</label>
            <input type="number" id="ai_raw" placeholder="Raw"/>
            <input type="number" id="ai_peer" placeholder="Peer Max"/>
            <input type="number" id="ai" placeholder="0–100"/>
          </div>
          <div class="hr"></div>
          <div class="mini">
            <label style="width:100%" data-i="repW">Weights in Reputation (sum=100)</label>
            <input type="number" id="w_si" value="40"/>
            <input type="number" id="w_ci" value="25"/>
            <input type="number" id="w_ei" value="20"/>
            <input type="number" id="w_ai" value="15"/>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="mini" style="align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
        <div class="mini" style="flex:1">
          <label style="width:100%" data-i="topW">Top Weights: Publicity vs Reputation</label>
          <input type="number" id="w_pub" value="50"/>
          <input type="number" id="w_rep" value="50"/>
        </div>
        <div class="mini">
          <button id="normalizeBtn" class="btn alt" data-i="norm">Normalize Raw → %</button>
        </div>
      </div>
      <div class="note" data-i="tip">Tip: choose a realistic benchmark (peer max) for your niche (leader/target) when normalizing.</div>
    </section>

    <!-- RESULTS -->
    <section class="card" id="report">
      <h3 data-i="res">Results</h3>
      <div class="score">
        <div class="pill">
          <div data-i="pubS">Publicity</div>
          <b id="pubScore">0</b>
          <progress id="pubProg" class="low" value="0" max="100"></progress>
        </div>
        <div class="pill">
          <div data-i="repS">Reputation</div>
          <b id="repScore">0</b>
          <progress id="repProg" class="low" value="0" max="100"></progress>
        </div>
        <div class="pill">
          <div data-i="socS">Social Score</div>
          <b id="socScore">0</b>
          <progress id="socProg" class="low" value="0" max="100"></progress>
        </div>
      </div>

      <div class="legend">
        <span class="badge b-ok" data-i="thr1">80–100 → High-profile, positive public figure</span>
        <span class="badge b-mid" data-i="thr2">60–79 → Recognized, mostly positive reputation</span>
        <span class="badge b-low" data-i="thr3">40–59 → Niche visibility / mixed; &lt;40 → Low/negative</span>
      </div>

      <div class="hr"></div>
      <div id="insights" class="muted" data-i="empty">Enter inputs and press <b>Calculate</b> to see insights.</div>

      <div class="hr"></div>
      <div class="right">
        <button id="makeSlides" class="btn" data-i="slides">Export Carousel (PNG 1080×1350)</button>
        <button id="downloadZip" class="btn alt">Download ZIP</button>
        <button onclick="window.print()" class="btn alt" data-i="pdf">Print / Save PDF</button>
      </div>
      <div id="slidesWall" class="slides"></div>
    </section>
  </div>

  <section class="card" id="how" style="margin-top:16px">
    <h3 data-i="howTitle">How normalization works</h3>
    <p class="muted" data-i="howText">
      % = <code>min(100, round(raw / peerMax * 100))</code>.
      For huge scale differences, enable <b>log normalization</b>:
      <code>round( log10(1+raw) / log10(1+peerMax) * 100 )</code>.
      SVI is already 0–100 (Google Trends).
    </p>
  </section>

  <footer>
    <div>© <span id="yr"></span> :self—maestro · <a href="https://selfmaestro.co/" target="_blank" rel="noopener">selfmaestro.co</a></div>
  </footer>
</div>

<script>
/* ===== i18n ===== */
const I = {
  en:{
    title:"Social Score Calculator by :SM",
    subtitle:"Measure a personal brand using two dimensions: <b>Publicity</b> (visibility) and <b>Reputation</b> (perception). Default weighting: 50/50. Adjust below.",
    start:"Start Now", how:"How it works",
    inputsTitle:"Inputs · enter Raw + Peer Max → we normalize (0–100)",
    logNorm:"Use log normalization for MMI & SRI (big-scale niches)",
    calc:"Calculate", reset:"Reset", clear:"Clear Saved",
    pub:"Publicity (Visibility)", pubW:"Weights in Publicity (sum=100)",
    rep:"Reputation (Perception)", repW:"Weights in Reputation (sum=100)",
    topW:"Top Weights: Publicity vs Reputation",
    norm:"Normalize Raw → %", tip:"Tip: choose a realistic benchmark (peer max) for your niche (leader/target) when normalizing.",
    res:"Results", pubS:"Publicity", repS:"Reputation", socS:"Social Score",
    thr1:"80–100 → High-profile, positive public figure",
    thr2:"60–79 → Recognized, mostly positive reputation",
    thr3:"40–59 → Niche visibility / mixed; <40 → Low/negative",
    empty:"Enter inputs and press <b>Calculate</b> to see insights.",
    slides:"Export Carousel (PNG 1080×1350)", pdf:"Print / Save PDF",
    howTitle:"How normalization works",
    howText:"% = <code>min(100, round(raw / peerMax * 100))</code>. For huge scale differences, enable <b>log normalization</b>: <code>round( log10(1+raw) / log10(1+peerMax) * 100 )</code>. SVI is already 0–100 (Google Trends).",
    cover:"Social Score", coverSub:"Publicity + Reputation → Social Score",
    weak:"Weak links", next:"Next moves", interp:"Interpretation",
    modeLbl:"Carousel"
  },
  ua:{
    title:"Калькулятор Social Score від :SM",
    subtitle:"Оціни персональний бренд за двома вимірами: <b>Publicity</b> (видимість) і <b>Reputation</b> (сприйняття). За замовчуванням 50/50. Можна змінити нижче.",
    start:"Почати", how:"Як це працює",
    inputsTitle:"Поля · введи Raw + Peer Max → ми нормалізуємо (0–100)",
    logNorm:"Використовувати логарифмічну нормалізацію для MMI та SRI",
    calc:"Розрахувати", reset:"Скинути", clear:"Очистити збережене",
    pub:"Publicity (Видимість)", pubW:"Ваги в Publicity (сума=100)",
    rep:"Reputation (Сприйняття)", repW:"Ваги в Reputation (сума=100)",
    topW:"Верхні ваги: Publicity vs Reputation",
    norm:"Нормалізувати Raw → %", tip:"Порада: обери реалістичний бенчмарк (peer max) для своєї ніші.",
    res:"Результати", pubS:"Publicity", repS:"Reputation", socS:"Social Score",
    thr1:"80–100 → Високий профіль, позитивний імідж",
    thr2:"60–79 → Впізнаваний, здебільшого позитивний",
    thr3:"40–59 → Нішева видимість / змішана; <40 → низька/негативна",
    empty:"Введи дані та натисни <b>Розрахувати</b>, щоб побачити інсайти.",
    slides:"Експорт у карусель (PNG 1080×1350)", pdf:"Друк / Зберегти PDF",
    howTitle:"Як працює нормалізація",
    howText:"% = <code>min(100, round(raw / peerMax * 100))</code>. Для великих розривів вмикай <b>лог-нормалізацію</b>: <code>round( log10(1+raw) / log10(1+peerMax) * 100 )</code>. SVI вже у шкалі 0–100.",
    cover:"Social Score", coverSub:"Publicity + Reputation → Social Score",
    weak:"Слабкі ланки", next:"Наступні кроки", interp:"Інтерпретація",
    modeLbl:"Карусель"
  }
};
let LANG = (localStorage.getItem('sm_lang') || 'en');

/* ===== helpers ===== */
const $=s=>document.querySelector(s);
$('#yr').textContent=new Date().getFullYear();
const clamp01=v=>Math.max(0,Math.min(1,v));
const n=v=>Number.isFinite(+v)?+v:0;
function norm(raw,peer,log=false){
  raw=Math.max(0,n(raw)); peer=Math.max(1,n(peer));
  if(log){ const r=Math.log10(1+raw), p=Math.log10(1+peer); return Math.min(100, Math.round((r/Math.max(0.000001,p))*100)); }
  return Math.min(100, Math.round(raw/peer*100));
}
function wavg(vals,wts){ const s=wts.reduce((a,b)=>a+b,0)||1; return vals.reduce((a,v,i)=>a+v*(wts[i]/s),0); }
function colorClass(v){ return v>=80?'ok':v>=60?'mid':'low'; }
function bucket(score){
  if(score>=80) return {txt:I[LANG].thr1,cls:'b-ok'};
  if(score>=60) return {txt:I[LANG].thr2,cls:'b-mid'};
  return {txt:I[LANG].thr3,cls:'b-low'};
}
function applyI18n(){
  const d=I[LANG];
  document.querySelectorAll('[data-i]').forEach(el=>{el.innerHTML=d[el.getAttribute('data-i')]});
  document.title = d.title;
  document.documentElement.lang = LANG;
  localStorage.setItem('sm_lang', LANG);
}

/* ===== autosave (localStorage) ===== */
const INPUT_IDS = ['mmi_raw','mmi_peer','mmi','sri_raw','sri_peer','sri','svi','cfi_raw','cfi_peer','cfi','si','ci','ei_raw','ei_peer','ei','ai_raw','ai_peer','ai','w_mmi','w_sri','w_svi','w_cfi','w_si','w_ci','w_ei','w_ai','w_pub','w_rep','logToggle'];
function saveState(){
  const state={};
  INPUT_IDS.forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    state[id] = el.type==='checkbox' ? el.checked : el.value;
  });
  state.carouselMode = $('#carouselMode').value;
  localStorage.setItem('sm_state', JSON.stringify(state));
}
function loadState(){
  const raw = localStorage.getItem('sm_state');
  if(!raw) return;
  try{
    const s=JSON.parse(raw);
    INPUT_IDS.forEach(id=>{
      const el=document.getElementById(id);
      if(!el || s[id]===undefined) return;
      if(el.type==='checkbox') el.checked = !!s[id]; else el.value = s[id];
    });
    if(s.carouselMode) $('#carouselMode').value = s.carouselMode;
  }catch(e){}
}
document.addEventListener('input', (e)=>{ if(e.target.matches('input,select')) saveState(); });
$('#clearSaved').addEventListener('click', ()=>{ localStorage.removeItem('sm_state'); alert('Saved state cleared'); });

/* ===== normalization & calc ===== */
$('#normalizeBtn').addEventListener('click', ()=>{
  const log = $('#logToggle').checked;
  $('#mmi').value = norm($('#mmi_raw').value, $('#mmi_peer').value, log);
  $('#sri').value = norm($('#sri_raw').value, $('#sri_peer').value, log);
  $('#cfi').value = norm($('#cfi_raw').value, $('#cfi_peer').value, false);
  $('#ei').value  = norm($('#ei_raw').value,  $('#ei_peer').value,  false);
  $('#ai').value  = norm($('#ai_raw').value,  $('#ai_peer').value,  false);
  saveState();
});

function calc(){
  const mmi=n($('#mmi').value), sri=n($('#sri').value), svi=n($('#svi').value), cfi=n($('#cfi').value);
  const si=n($('#si').value), ci=n($('#ci').value), ei=n($('#ei').value), ai=n($('#ai').value);
  const w_mmi=n($('#w_mmi').value), w_sri=n($('#w_sri').value), w_svi=n($('#w_svi').value), w_cfi=n($('#w_cfi').value);
  const w_si=n($('#w_si').value), w_ci=n($('#w_ci').value), w_ei=n($('#w_ei').value), w_ai=n($('#w_ai').value);
  let t_pub=clamp01(n($('#w_pub').value)/100), t_rep=clamp01(n($('#w_rep').value)/100);
  const s=t_pub+t_rep||1; t_pub/=s; t_rep/=s;

  const publicity = wavg([mmi,sri,svi,cfi],[w_mmi,w_sri,w_svi,w_cfi]);
  const reputation = wavg([si,ci,ei,ai],[w_si,w_ci,w_ei,w_ai]);
  const social = Math.round(publicity*t_pub + reputation*t_rep);

  $('#pubScore').textContent=Math.round(publicity);
  $('#repScore').textContent=Math.round(reputation);
  $('#socScore').textContent=social;
  ['pubProg','repProg','socProg'].forEach(id=>{ const el=$('#'+id); el.classList.remove('ok','mid','low'); });
  $('#pubProg').classList.add(colorClass(publicity)); $('#repProg').classList.add(colorClass(reputation)); $('#socProg').classList.add(colorClass(social));
  $('#pubProg').value=Math.round(publicity); $('#repProg').value=Math.round(reputation); $('#socProg').value=social;

  const weak=[]; if(mmi<60)weak.push('MMI'); if(sri<60)weak.push('SRI'); if(svi<60)weak.push('SVI'); if(cfi<60)weak.push('CFI');
  if(si<60)weak.push('SI'); if(ci<60)weak.push('CI'); if(ei<60)weak.push('EI'); if(ai<60)weak.push('AI');
  const cat=bucket(social);
  const tips=[ 'Recalculate monthly with benchmarks','Strengthen trust signals → CI','Collaborate to compound EI & AI','Publish consistently → CFI & SVI' ];
  $('#insights').innerHTML =
     `<p><b>${I[LANG].interp}:</b> <span class="badge ${cat.cls}">${cat.txt}</span></p>`+
     `<p><b>${I[LANG].pubS}:</b> ${Math.round(publicity)} · <b>${I[LANG].repS}:</b> ${Math.round(reputation)} · `+
     `<b>Weights:</b> Pub ${Math.round(t_pub*100)}% / Rep ${Math.round(t_rep*100)}%</p>`+
     (weak.length? `<p><b>${I[LANG].weak}:</b> ${weak.join(', ')}.</p>` : `<p><b>Nice:</b> no metric below 60.</p>`) +
     `<p><b>${I[LANG].next}:</b> ${tips.join(' • ')}</p>`;
  saveState();
  return {publicity,reputation,social,weak, metrics:[mmi,sri,svi,cfi,si,ci,ei,ai]};
}
$('#calcBtn').addEventListener('click', calc);
$('#reset').addEventListener('click', ()=>{
  document.querySelectorAll('input[type="number"]').forEach(i=>i.value='');
  ['pubScore','repScore','socScore'].forEach(id=>document.getElementById(id).textContent='0');
  ['pubProg','repProg','socProg'].forEach(id=>document.getElementById(id).value=0);
  $('#insights').innerHTML=I[LANG].empty;
  saveState();
});

/* ===== Canvas helpers for slides ===== */
function makeCanvas(w=1080,h=1350){ const c=document.createElement('canvas'); c.width=w; c.height=h; const g=c.getContext('2d'); return {c,g}; }
function bg(g){ g.fillStyle='#0B0C10'; g.fillRect(0,0,1080,1350); }
function titleC(g,txt,y=220){ g.fillStyle='#FFFFFF'; g.font='900 92px Inter, Arial'; g.textAlign='center'; g.fillText(txt,540,y); }
function subC(g,txt,y=320,maxW=920){ g.fillStyle='#C7FF22'; g.font='800 42px Inter, Arial'; g.textAlign='center'; wrapText(g,txt,540,y,maxW,56); }
function textC(g,txt,y=420,maxW=980,lh=56){ g.fillStyle='#E8ECF1'; g.font='700 42px Inter, Arial'; g.textAlign='center'; wrapText(g,txt,540,y,maxW,lh); }
function smallC(g,txt,y){ g.fillStyle='#AAB4C2'; g.font='600 30px Inter, Arial'; g.textAlign='center'; g.fillText(txt,540,y); }
function chip(g,txt,x,y){ g.fillStyle='#C7FF22'; const w = g.measureText(txt).width + 28; g.fillRect(x-14,y-40,w,50);
  g.fillStyle='#111'; g.font='900 30px Inter, Arial'; g.textAlign='left'; g.fillText(txt,x,y-8); }
function wrapText(g,text,x,y,maxWidth,lineHeight){
  const words=String(text).split(' '); let line=''; let yy=y;
  for(let n=0;n<words.length;n++){ const test=line+words[n]+' '; const w=g.measureText(test).width;
    if(w>maxWidth && n>0){ g.fillText(line,x,yy); line=words[n]+' '; yy+=lineHeight; } else line=test;
  } g.fillText(line,x,yy);
}
function footer(g){
  g.fillStyle='#C7FF22'; g.fillRect(0,1260,1080,90);
  g.fillStyle='#111'; g.font='900 32px Inter, Arial'; g.textAlign='left'; g.fillText(':self—maestro',32,1318);
  g.textAlign='right'; g.font='800 28px Inter, Arial'; g.fillText('selfmaestro.co',1048,1318);
}

/* Simple bars (0–100) for publicity/reputation */
function bars(g,labels,values,x=140,y=480,w=800,h=300){
  const n=labels.length, gap=16, barH=(h - gap*(n-1))/n;
  for(let i=0;i<n;i++){
    g.fillStyle='#1D2533'; g.fillRect(x, y + i*(barH+gap), w, barH);
    const pct = Math.max(0, Math.min(100, values[i]))/100;
    g.fillStyle='#C7FF22'; g.fillRect(x, y + i*(barH+gap), w*pct, barH);
    g.fillStyle='#E8ECF1'; g.font='600 34px Inter, Arial'; g.textAlign='left';
    g.fillText(`${labels[i]} — ${Math.round(values[i])}`, x, y + i*(barH+gap) - 10);
  }
}

/* Radar 8 metrics on 500px circle */
function radar(g,values,labels,cx=540,cy=750,r=350){
  const N=values.length;
  // axes
  g.strokeStyle='#2A3546'; g.lineWidth=2;
  for(let i=0;i<N;i++){
    const a = -Math.PI/2 + i*(2*Math.PI/N);
    g.beginPath(); g.moveTo(cx,cy); g.lineTo(cx + r*Math.cos(a), cy + r*Math.sin(a)); g.stroke();
  }
  // rings
  for(let k=1;k<=4;k++){
    g.beginPath();
    for(let i=0;i<N;i++){
      const a = -Math.PI/2 + i*(2*Math.PI/N);
      const rr = r*(k/4);
      const x = cx + rr*Math.cos(a), y = cy + rr*Math.sin(a);
      if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
    }
    g.closePath(); g.stroke();
  }
  // polygon
  g.beginPath();
  for(let i=0;i<N;i++){
    const a = -Math.PI/2 + i*(2*Math.PI/N);
    const rr = r*(Math.max(0,Math.min(100,values[i]))/100);
    const x = cx + rr*Math.cos(a), y = cy + rr*Math.sin(a);
    if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
  }
  g.closePath(); g.fillStyle='rgba(199,255,34,0.35)'; g.fill(); g.strokeStyle='#C7FF22'; g.lineWidth=3; g.stroke();

  // labels
  g.fillStyle='#E8ECF1'; g.font='600 28px Inter, Arial'; g.textAlign='center';
  for(let i=0;i<N;i++){
    const a = -Math.PI/2 + i*(2*Math.PI/N);
    const x = cx + (r+36)*Math.cos(a), y = cy + (r+36)*Math.sin(a);
    g.fillText(labels[i], x, y);
  }
}

/* ===== Export slides + ZIP ===== */
let lastSlidePNGs = []; // {name, dataURL}
function addPreview(canvas){ const wall=$('#slidesWall'); wall.appendChild(canvas); }
function dlDataURL(name, dataURL){ const a=document.createElement('a'); a.href=dataURL; a.download=name; a.click(); }
async function buildZipAndDownload(){
  if(!lastSlidePNGs.length){ alert('No slides yet. Click “Export Carousel” first.'); return; }
  const zip = new JSZip();
  lastSlidePNGs.forEach((s, i)=>{
    const base64 = s.dataURL.split(',')[1];
    zip.file(s.name, base64, {base64:true});
  });
  const blob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'social-score-slides.zip'; a.click();
  URL.revokeObjectURL(a.href);
}
$('#downloadZip').addEventListener('click', buildZipAndDownload);

$('#makeSlides').addEventListener('click', ()=>{
  const {publicity,reputation,social,weak,metrics}=calc(); // refresh
  $('#slidesWall').innerHTML=''; lastSlidePNGs = [];
  const yr = new Date().getFullYear();
  const mode = $('#carouselMode').value;

  // 1) Cover
  (()=>{ const {c,g}=makeCanvas(); bg(g);
    titleC(g, I[LANG].cover, 220); subC(g, I[LANG].coverSub, 310);
    textC(g, `${I[LANG].socS}: ${Math.round(social)}/100`, 450);
    smallC(g, `© ${yr} selfmaestro.co`, 1220); footer(g); addPreview(c);
    lastSlidePNGs.push({name:'01-cover-social-score.png', dataURL:c.toDataURL('image/png')});
  })();

  if(mode==='classic'){
    // 2) Publicity (bars)
    (()=>{ const {c,g}=makeCanvas(); bg(g); chip(g,'Publicity',72,120);
      titleC(g, `${Math.round(publicity)}/100`, 240);
      bars(g, ['MMI','SRI','SVI','CFI'], metrics.slice(0,4));
      footer(g); addPreview(c);
      lastSlidePNGs.push({name:'02-publicity.png', dataURL:c.toDataURL('image/png')});
    })();
    // 3) Reputation (bars)
    (()=>{ const {c,g}=makeCanvas(); bg(g); chip(g,'Reputation',72,120);
      titleC(g, `${Math.round(reputation)}/100`, 240);
      bars(g, ['SI','CI','EI','AI'], metrics.slice(4,8));
      footer(g); addPreview(c);
      lastSlidePNGs.push({name:'03-reputation.png', dataURL:c.toDataURL('image/png')});
    })();
  } else {
    // Charts/Radar
    // 2) Bars (all 8)
    (()=>{ const {c,g}=makeCanvas(); bg(g); chip(g,'Metrics',72,120);
      titleC(g, 'Scores (0–100)', 240);
      bars(g, ['MMI','SRI','SVI','CFI','SI','CI','EI','AI'], metrics, 80, 360, 920, 520);
      footer(g); addPreview(c);
      lastSlidePNGs.push({name:'02-bars.png', dataURL:c.toDataURL('image/png')});
    })();
    // 3) Radar
    (()=>{ const {c,g}=makeCanvas(); bg(g); chip(g,'Radar',72,120);
      titleC(g, `${Math.round(social)}/100`, 240);
      radar(g, metrics, ['MMI','SRI','SVI','CFI','SI','CI','EI','AI']);
      footer(g); addPreview(c);
      lastSlidePNGs.push({name:'03-radar.png', dataURL:c.toDataURL('image/png')});
    })();
  }

  // 4) Summary
  (()=>{ const {c,g}=makeCanvas(); bg(g); chip(g, I[LANG].interp,72,120);
    const cat=bucket(social); titleC(g, `${Math.round(social)}/100`, 240);
    subC(g, cat.txt, 320, 940);
    textC(g, (weak.length? `${I[LANG].weak}: ${weak.join(', ')}` : 'No weak metrics below 60.'), 470, 980, 50);
    textC(g, `${I[LANG].next}: Recalculate monthly • Strengthen CI • Collaborate for EI/AI • Publish consistently`, 640, 1000, 48);
    footer(g); addPreview(c);
    lastSlidePNGs.push({name:'04-summary.png', dataURL:c.toDataURL('image/png')});
  })();

  // auto-download individual PNGs (optional — коментни наступні 3 рядки, якщо не потрібно)
  lastSlidePNGs.forEach(s=>{ dlDataURL(s.name, s.dataURL); });
});

document.querySelectorAll('[data-lang]').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); LANG=b.dataset.lang; applyI18n(); saveState();
}));

/* ===== boot ===== */
applyI18n();
loadState();
document.querySelectorAll('[data-lang]').forEach(b=>{ if(b.dataset.lang===LANG) b.classList.add('active'); else b.classList.remove('active'); });
</script>
</body>
</html>
